<div class="rounded-xl bg-white animate-fade-in border border-gray-200">
    <div class="px-4 py-3 sm:px-5 sm:py-4 border-b border-gray-200">
        <div class="flex items-center gap-2 text-zinc-900">
        <ng-container *ngIf="isEditing(); else addTpl">
            <lucide-icon name="edit-3" class="w-5 h-5"></lucide-icon>
            <h3 class="font-semibold text-base sm:text-lg">Editar Participante</h3>
        </ng-container>
        <ng-template #addTpl>
            <lucide-icon name="user-plus" class="w-5 h-5"></lucide-icon>
            <h3 class="font-semibold text-base sm:text-lg">Adicionar Participante</h3>
        </ng-template>
        </div>
    </div>

    <div class="p-4 sm:p-5">
        <form [formGroup]="form" (ngSubmit)="onSubmit()" class="space-y-6">
            <div class="space-y-2">
                <label for="name" class="text-sm font-medium">Nome do Colaborador<span class="text-red-500">*</span></label>
                <input
                id="name"
                type="text"
                formControlName="name"
                placeholder="Digite o nome completo"
                autocomplete="name"
                class="w-full rounded-lg border p-2 outline-none focus:ring focus:ring-indigo-300 [&.ng-invalid.ng-touched]:border-red-500"
                />
                <p
                *ngIf="form.get('name')?.touched && form.get('name')?.invalid"
                class="text-[0.75rem] text-red-700 font-semibold"
                >
                Nome é obrigatório
                </p>
            </div>

            <div class="space-y-2">
                <div class="flex items-center gap-2">
                    <label for="cpf" class="text-sm font-medium">CPF<span class="text-red-500">*</span></label>
                    <lucide-icon
                        *ngIf="isEditing()"
                        name="lock-keyhole"
                        class="w-4 h-4 text-zinc-400"
                        title="Não é possível alterar o CPF"
                    ></lucide-icon>
                </div>
                <input
                id="cpf"
                type="text"
                formControlName="cpf"
                (input)="onCpfInput($event)"
                maxlength="14"
                placeholder="000.000.000-00"
                inputmode="numeric"
                autocomplete="off"
                class="w-full rounded-lg border p-2 outline-none focus:ring focus:ring-indigo-200 [&.ng-invalid.ng-touched]:border-red-500 disabled:bg-zinc-100 disabled:text-zinc-500 disabled:cursor-not-allowed"
                />
                <p *ngIf="isEditing()" class="text-[0.75rem] text-zinc-500 font-medium">
                    O CPF não pode ser alterado após o cadastro.
                </p>
                <div
                    *ngIf="form.get('cpf')?.invalid && form.get('cpf')?.touched"
                    class="text-[0.75rem] text-red-700 font-semibold"
                    >
                    <p *ngIf="form.get('cpf')?.hasError('required')">CPF é obrigatório.</p>
                    <p *ngIf="!form.get('cpf')?.hasError('required') && form.get('cpf')?.hasError('cpf')">
                        CPF inválido.
                    </p>
                </div>
            </div>

            <div class="space-y-2">
                <div class="flex items-center gap-2">
                    <label for="breakfastDate" class="text-sm font-medium">Data do Café<span class="text-red-500">*</span></label>
                    <lucide-icon
                        *ngIf="isEditing()"
                        name="lock-keyhole"
                        class="w-4 h-4 text-zinc-400"
                        title="Não é possível alterar a data"
                    ></lucide-icon>
                </div>
                <input
                id="breakfastDate"
                type="date"
                formControlName="breakfastDate"
                class="w-full rounded-lg border p-2 outline-none focus:ring focus:ring-indigo-200 [&.ng-invalid.ng-touched]:border-red-500 disabled:bg-zinc-100 disabled:text-zinc-500 disabled:cursor-not-allowed"
                />
                <p *ngIf="isEditing()" class="text-[0.75rem] text-zinc-500 font-medium">
                    A data do café não pode ser alterada na edição.
                </p>
                <p
                *ngIf="form.get('breakfastDate')?.touched && form.get('breakfastDate')?.errors?.['future']"
                class="text-[0.75rem] text-red-700 font-semibold"
                >
                    A data deve ser futura
                </p>
                <p
                *ngIf="form.get('breakfastDate')?.touched && form.get('breakfastDate')?.errors?.['required']"
                class="text-[0.75rem] text-red-700 font-semibold"
                >
                    Data é obrigatória
                </p>
            </div>

            <div class="space-y-3">
                <label class="text-sm font-medium">Itens para o Café<span class="text-red-500">*</span></label>

                <div class="flex flex-col gap-2 sm:flex-row">
                    <input
                        type="text"
                        [formControl]="newItem"
                        placeholder="Ex: Bolo de Chocolate"
                        (keydown.enter)="$event.preventDefault(); addItem();"
                        class="flex-1 rounded-lg border p-2 outline-none focus:ring focus:ring-indigo-200"
                    />
                    <button
                        type="button"
                        (click)="addItem()"
                        class="rounded-lg border px-3 py-2 hover:bg-zinc-50 sm:px-3"
                        aria-label="Adicionar item"
                    >
                        <lucide-icon name="plus" class="w-4 h-4 mx-auto sm:mx-0"></lucide-icon>
                    </button>
                </div>

                <div *ngIf="items.controls.length > 0" class="grid gap-2 sm:grid-cols-2">
                    <div *ngFor="let ctrl of items.controls; let i = index" class="flex items-center justify-between p-2 bg-zinc-100 rounded-lg">
                        <span class="text-sm truncate">{{ ctrl.get('name')?.value }}</span>
                        <button
                        type="button"
                        (click)="removeItem(i)"
                        class="h-8 w-8 grid place-items-center rounded-full hover:bg-red-100 text-red-600"
                        aria-label="Remover item"
                        >
                            <lucide-icon name="x" class="w-4 h-4"></lucide-icon>
                        </button>
                    </div>
                </div>

                <p
                *ngIf="form.get('items')?.errors?.['manual']"
                class="text-[0.75rem] text-red-700 font-semibold"
                >
                    {{ form.get('items')?.errors?.['manual'] }}
                </p>
            </div>

            <div class="flex flex-col-reverse gap-3 sm:flex-row sm:justify-end sm:items-center">
                <button *ngIf="isEditing()" type="button" (click)="onCancelClick()" class="px-4 py-2 rounded-lg border text-blue-600 border-blue-500 hover:bg-zinc-50">
                    Cancelar
                </button>

                <button type="submit" class="rounded-lg text-white px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-60 disabled:cursor-not-allowed" [disabled]="form.invalid || (isEditing() && !form.dirty)">
                    {{ isEditing() ? 'Atualizar Participante' : 'Salvar Participante' }}
                </button>
            </div>

            <div class="flex w-full items-center min-h-5" aria-live="polite">
                <p *ngIf="errorMessage()" class="text-[0.75rem] text-red-700 font-semibold">
                    {{ errorMessage() }}
                </p>
                <p *ngIf="!errorMessage() && successMessage()" class="text-[0.75rem] text-emerald-700 font-semibold">
                    {{ successMessage() }}
                </p>
            </div>
        </form>
    </div>
</div>
